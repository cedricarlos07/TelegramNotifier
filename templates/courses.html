{% extends 'layout.html' %}

{% block page_header %}
<h1 class="h3 mb-0 text-light">Gestion des Cours</h1>
{% endblock %}

{% block content %}
<!-- Action buttons & Stats Overview -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body p-0">
                <!-- Progress stats -->
                <div class="row g-0">
                    <div class="col-md-4 p-4 border-end border-dark">
                        <h6 class="text-muted mb-1 text-uppercase small">Total Cours</h6>
                        <div class="d-flex align-items-center">
                            <h3 class="mb-0 me-2 fw-bold">{{ total_courses }}</h3>
                            <div class="text-primary text-opacity-75">
                                <i class="fas fa-graduation-cap"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 p-4 border-end border-dark">
                        <h6 class="text-muted mb-1 text-uppercase small">Avec Zoom</h6>
                        <div class="d-flex align-items-center">
                            <h3 class="mb-0 me-2 fw-bold">{{ courses_with_zoom }}</h3>
                            <div class="text-info text-opacity-75">
                                <i class="fas fa-video"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 p-4">
                        <h6 class="text-muted mb-1 text-uppercase small">Planifiés</h6>
                        <div class="d-flex align-items-center">
                            <h3 class="mb-0 me-2 fw-bold">{{ planning_progress }}%</h3>
                            <div class="text-success text-opacity-75">
                                <i class="fas fa-calendar-check"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="mb-1 fw-bold">Ajouter un nouveau cours</h6>
                    <p class="text-muted mb-0 small">Créer une nouvelle planification de cours</p>
                </div>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCourseModal">
                    <i class="fas fa-plus-circle me-2"></i>Nouveau Cours
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Progress bar -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="fw-bold mb-0">Progression de la planification</h6>
                    <span class="badge bg-primary rounded-pill px-3">{{ planning_progress }}%</span>
                </div>
                <div class="progress">
                    {% if planning_progress < 30 %}
                        {% set progress_color = "bg-danger" %}
                    {% elif planning_progress < 70 %}
                        {% set progress_color = "bg-warning" %}
                    {% else %}
                        {% set progress_color = "bg-success" %}
                    {% endif %}
                    
                    <div class="progress-bar {{ progress_color }}" role="progressbar" style="width: {{ planning_progress }}%;" 
                         aria-valuenow="{{ planning_progress }}" aria-valuemin="0" aria-valuemax="100">
                    </div>
                </div>
                
                <div class="d-flex justify-content-between mt-3">
                    <div class="d-flex align-items-center">
                        <div class="dot bg-success me-2"></div>
                        <small class="text-muted">{{ courses_with_zoom }} avec liens Zoom</small>
                    </div>
                    <div class="d-flex align-items-center">
                        <div class="dot bg-warning me-2"></div>
                        <small class="text-muted">{{ total_courses - courses_with_zoom }} en attente</small>
                    </div>
                    <div class="d-flex align-items-center">
                        <div class="dot bg-info me-2"></div>
                        <small class="text-muted">{{ total_courses }} cours au total</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Filter section -->
<div class="filter-section mb-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0 fw-bold"><i class="fas fa-filter me-2 text-primary"></i>Filtres</h5>
        <button class="btn btn-sm btn-link text-muted" type="button" data-bs-toggle="collapse" data-bs-target="#filterCollapse" aria-expanded="false" aria-controls="filterCollapse">
            <i class="fas fa-chevron-down"></i>
        </button>
    </div>
    
    <div class="collapse show" id="filterCollapse">
        <form id="filterForm" class="row g-3">
            <div class="col-md-3">
                <label for="filter_teacher" class="form-label">Professeur</label>
                <select class="form-select" id="filter_teacher" name="teacher">
                    <option value="">Tous les professeurs</option>
                    {% for teacher in teachers %}
                        <option value="{{ teacher }}">{{ teacher }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label for="filter_class" class="form-label">Classe</label>
                <select class="form-select" id="filter_class" name="class">
                    <option value="">Toutes les classes</option>
                    {% for class_name in class_names %}
                        <option value="{{ class_name }}">{{ class_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label for="filter_group" class="form-label">Groupe Telegram</label>
                <select class="form-select" id="filter_group" name="group">
                    <option value="">Tous les groupes</option>
                    {% for group in telegram_groups %}
                        <option value="{{ group }}">{{ group }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label for="filter_period" class="form-label">Période</label>
                <select class="form-select" id="filter_period" name="period">
                    <option value="">Toutes les périodes</option>
                    <option value="this_week">Cette semaine</option>
                    <option value="next_week">Semaine prochaine</option>
                    <option value="this_month">Ce mois</option>
                </select>
            </div>
            <div class="col-12 d-flex gap-2">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-filter me-2"></i>Appliquer les filtres
                </button>
                <button type="reset" class="btn btn-outline-secondary">
                    <i class="fas fa-undo me-2"></i>Réinitialiser
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Course Tabs -->
<div class="card">
    <div class="card-header">
        <ul class="nav nav-tabs card-header-tabs" id="courseTabs" role="tablist">
            {% for day in days %}
            <li class="nav-item" role="presentation">
                <button class="nav-link {% if loop.first %}active{% endif %}" 
                        id="{{ day.lower() }}-tab" 
                        data-bs-toggle="tab" 
                        data-bs-target="#{{ day.lower() }}" 
                        type="button" 
                        role="tab" 
                        aria-controls="{{ day.lower() }}" 
                        aria-selected="{% if loop.first %}true{% else %}false{% endif %}">
                    {{ day }}
                </button>
            </li>
            {% endfor %}
        </ul>
    </div>
    <div class="card-body">
        <div class="tab-content" id="courseTabsContent">
            {% for day in days %}
            <div class="tab-pane fade {% if loop.first %}show active{% endif %}" 
                 id="{{ day.lower() }}" 
                 role="tabpanel" 
                 aria-labelledby="{{ day.lower() }}-tab">
                
                {% if courses_by_day[day] %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Course</th>
                                <th>Teacher</th>
                                <th>Telegram Group</th>
                                <th>Next Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for course in courses_by_day[day] %}
                            <tr>
                                <td>{{ course.start_time.strftime('%H:%M') }} - {{ course.end_time.strftime('%H:%M') }}</td>
                                <td>{{ course.course_name }}</td>
                                <td>{{ course.teacher_name }}</td>
                                <td>{{ course.telegram_group_id }}</td>
                                <td>
                                    {% if course.schedule_date %}
                                        {{ course.schedule_date.strftime('%d-%m-%Y') }}
                                    {% else %}
                                        <span class="badge bg-warning text-dark">Not scheduled</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-info edit-course-btn" 
                                            data-course-id="{{ course.id }}"
                                            data-course-name="{{ course.course_name }}"
                                            data-teacher-name="{{ course.teacher_name }}"
                                            data-day-of-week="{{ course.day_of_week }}"
                                            data-start-time="{{ course.start_time.strftime('%H:%M') }}"
                                            data-end-time="{{ course.end_time.strftime('%H:%M') }}"
                                            data-telegram-group-id="{{ course.telegram_group_id }}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger delete-course-btn" data-course-id="{{ course.id }}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info">No courses scheduled for {{ day }}.</div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Add Course Modal -->
<div class="modal fade" id="addCourseModal" tabindex="-1" aria-labelledby="addCourseModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addCourseModalLabel">Add New Course</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('add_course') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="course_name" class="form-label">Course Name</label>
                        <input type="text" class="form-control" id="course_name" name="course_name" required>
                    </div>
                    <div class="mb-3">
                        <label for="teacher_name" class="form-label">Teacher Name</label>
                        <input type="text" class="form-control" id="teacher_name" name="teacher_name" required>
                    </div>
                    <div class="mb-3">
                        <label for="day_of_week" class="form-label">Day of Week</label>
                        <select class="form-select" id="day_of_week" name="day_of_week" required>
                            <option value="0">Monday</option>
                            <option value="1">Tuesday</option>
                            <option value="2">Wednesday</option>
                            <option value="3">Thursday</option>
                            <option value="4">Friday</option>
                            <option value="5">Saturday</option>
                            <option value="6">Sunday</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="start_time" class="form-label">Start Time</label>
                        <input type="time" class="form-control" id="start_time" name="start_time" required>
                    </div>
                    <div class="mb-3">
                        <label for="end_time" class="form-label">End Time</label>
                        <input type="time" class="form-control" id="end_time" name="end_time" required>
                    </div>
                    <div class="mb-3">
                        <label for="telegram_group_id" class="form-label">Telegram Group ID</label>
                        <input type="text" class="form-control" id="telegram_group_id" name="telegram_group_id" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Course</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Course Modal -->
<div class="modal fade" id="editCourseModal" tabindex="-1" aria-labelledby="editCourseModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editCourseModalLabel">Edit Course</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editCourseForm" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="edit_course_name" class="form-label">Course Name</label>
                        <input type="text" class="form-control" id="edit_course_name" name="course_name" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_teacher_name" class="form-label">Teacher Name</label>
                        <input type="text" class="form-control" id="edit_teacher_name" name="teacher_name" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_day_of_week" class="form-label">Day of Week</label>
                        <select class="form-select" id="edit_day_of_week" name="day_of_week" required>
                            <option value="0">Monday</option>
                            <option value="1">Tuesday</option>
                            <option value="2">Wednesday</option>
                            <option value="3">Thursday</option>
                            <option value="4">Friday</option>
                            <option value="5">Saturday</option>
                            <option value="6">Sunday</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="edit_start_time" class="form-label">Start Time</label>
                        <input type="time" class="form-control" id="edit_start_time" name="start_time" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_end_time" class="form-label">End Time</label>
                        <input type="time" class="form-control" id="edit_end_time" name="end_time" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_telegram_group_id" class="form-label">Telegram Group ID</label>
                        <input type="text" class="form-control" id="edit_telegram_group_id" name="telegram_group_id" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Course Modal -->
<div class="modal fade" id="deleteCourseModal" tabindex="-1" aria-labelledby="deleteCourseModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteCourseModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this course? This action cannot be undone.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="deleteCourseForm" method="POST">
                    <button type="submit" class="btn btn-danger">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Handle Edit Course buttons
        document.querySelectorAll('.edit-course-btn').forEach(function(button) {
            button.addEventListener('click', function() {
                const courseId = this.getAttribute('data-course-id');
                const courseName = this.getAttribute('data-course-name');
                const teacherName = this.getAttribute('data-teacher-name');
                const dayOfWeek = this.getAttribute('data-day-of-week');
                const startTime = this.getAttribute('data-start-time');
                const endTime = this.getAttribute('data-end-time');
                const telegramGroupId = this.getAttribute('data-telegram-group-id');
                
                // Populate form
                document.getElementById('edit_course_name').value = courseName;
                document.getElementById('edit_teacher_name').value = teacherName;
                document.getElementById('edit_day_of_week').value = dayOfWeek;
                document.getElementById('edit_start_time').value = startTime;
                document.getElementById('edit_end_time').value = endTime;
                document.getElementById('edit_telegram_group_id').value = telegramGroupId;
                
                // Set form action
                document.getElementById('editCourseForm').action = `/courses/edit/${courseId}`;
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('editCourseModal'));
                modal.show();
            });
        });
        
        // Handle Delete Course buttons
        document.querySelectorAll('.delete-course-btn').forEach(function(button) {
            button.addEventListener('click', function() {
                const courseId = this.getAttribute('data-course-id');
                
                // Set form action
                document.getElementById('deleteCourseForm').action = `/courses/delete/${courseId}`;
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('deleteCourseModal'));
                modal.show();
            });
        });
        
        // Handle Filter Form
        const filterForm = document.getElementById('filterForm');
        if (filterForm) {
            filterForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Get filter values
                const teacher = document.getElementById('filter_teacher').value;
                const className = document.getElementById('filter_class').value;
                const group = document.getElementById('filter_group').value;
                const period = document.getElementById('filter_period').value;
                
                // Build URL with query parameters
                let url = window.location.pathname;
                const params = new URLSearchParams();
                
                if (teacher) params.append('teacher', teacher);
                if (className) params.append('class', className);
                if (group) params.append('group', group);
                if (period) params.append('period', period);
                
                // Redirect to filtered URL
                if (params.toString()) {
                    url += '?' + params.toString();
                }
                
                window.location.href = url;
            });
            
            // Handle reset button
            filterForm.querySelector('button[type="reset"]').addEventListener('click', function() {
                // Reset all selects
                filterForm.querySelectorAll('select').forEach(select => {
                    select.value = '';
                });
                
                // Go to base URL
                window.location.href = window.location.pathname;
            });
            
            // Pre-populate filter values from URL
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('teacher')) {
                document.getElementById('filter_teacher').value = urlParams.get('teacher');
            }
            if (urlParams.has('class')) {
                document.getElementById('filter_class').value = urlParams.get('class');
            }
            if (urlParams.has('group')) {
                document.getElementById('filter_group').value = urlParams.get('group');
            }
            if (urlParams.has('period')) {
                document.getElementById('filter_period').value = urlParams.get('period');
            }
        }
    });
    
    // Function to validate course form to prevent duplicates
    function validateCourseForm(formId) {
        const form = document.getElementById(formId);
        const dayOfWeek = form.querySelector('[name="day_of_week"]').value;
        const startTime = form.querySelector('[name="start_time"]').value;
        const endTime = form.querySelector('[name="end_time"]').value;
        const teacherName = form.querySelector('[name="teacher_name"]').value;
        
        // Check server-side if this is a duplicate
        return new Promise((resolve, reject) => {
            const formData = new FormData();
            formData.append('day_of_week', dayOfWeek);
            formData.append('start_time', startTime);
            formData.append('end_time', endTime);
            formData.append('teacher_name', teacherName);
            
            fetch('/api/check-course-conflict', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.conflict) {
                    if (confirm(`ATTENTION: Un cours similaire existe déjà:\n\n${data.details}\n\nVoulez-vous vraiment créer un cours en doublon?`)) {
                        resolve(true); // User confirmed to proceed despite conflict
                    } else {
                        resolve(false); // User cancelled
                    }
                } else {
                    resolve(true); // No conflict
                }
            })
            .catch(error => {
                console.error('Error checking course conflict:', error);
                // In case of error, allow form submission but warn user
                if (confirm('Impossible de vérifier les doublons. Voulez-vous continuer?')) {
                    resolve(true);
                } else {
                    resolve(false);
                }
            });
        });
    }
    
    // Add validation to add course form
    const addCourseForm = document.querySelector('#addCourseModal form');
    if (addCourseForm) {
        addCourseForm.addEventListener('submit', function(e) {
            e.preventDefault();
            validateCourseForm('addCourseModal').then(isValid => {
                if (isValid) {
                    this.submit();
                }
            });
        });
    }
    
    // Add validation to edit course form
    const editCourseForm = document.getElementById('editCourseForm');
    if (editCourseForm) {
        editCourseForm.addEventListener('submit', function(e) {
            e.preventDefault();
            validateCourseForm('editCourseForm').then(isValid => {
                if (isValid) {
                    this.submit();
                }
            });
        });
    }
</script>
{% endblock %}
