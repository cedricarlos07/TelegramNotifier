{% extends 'layout.html' %}

{% block page_header %}
<h1 class="h3 mb-0 text-light">Gestion des Cours</h1>
{% endblock %}

{% block styles %}
<style>
    /* Styles spécifiques à la page des cours */
    .table-hover tbody tr:hover {
        background-color: rgba(var(--bs-primary-rgb), 0.05);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">Gestion des Cours</h1>
            <p class="text-muted mb-0">Organisez et gérez vos cours et emplois du temps</p>
        </div>
        <div>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCourseModal">
                <i class="fas fa-plus-circle me-2"></i> Nouveau Cours
            </button>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="card stats-card h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="icon-circle bg-primary bg-opacity-10 text-primary me-3">
                            <i class="fas fa-graduation-cap"></i>
                        </div>
                        <div>
                            <h6 class="text-uppercase text-muted mb-1">Total Cours</h6>
                            <h3 class="mb-0">{{ courses|length }}</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="icon-circle bg-success bg-opacity-10 text-success me-3">
                            <i class="fas fa-users"></i>
                        </div>
                        <div>
                            <h6 class="text-uppercase text-muted mb-1">Total Étudiants</h6>
                            <h3 class="mb-0">{{ total_students }}</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="icon-circle bg-info bg-opacity-10 text-info me-3">
                            <i class="fas fa-chalkboard-teacher"></i>
                        </div>
                        <div>
                            <h6 class="text-uppercase text-muted mb-1">Total Professeurs</h6>
                            <h3 class="mb-0">{{ total_teachers }}</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="icon-circle bg-warning bg-opacity-10 text-warning me-3">
                            <i class="fas fa-calendar-check"></i>
                        </div>
                        <div>
                            <h6 class="text-uppercase text-muted mb-1">Cours Aujourd'hui</h6>
                            <h3 class="mb-0">{{ courses_today }}</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="card filter-card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">Filtres</h5>
        </div>
        <div class="card-body">
            <form id="filterForm" class="row g-3">
                <div class="col-md-3">
                    <label for="filter_teacher" class="form-label">Professeur</label>
                    <select class="form-select" id="filter_teacher" name="teacher">
                        <option value="">Tous les professeurs</option>
                        {% for teacher in teachers %}
                        <option value="{{ teacher.id }}">{{ teacher.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="filter_level" class="form-label">Niveau</label>
                    <select class="form-select" id="filter_level" name="level">
                        <option value="">Tous les niveaux</option>
                        {% for level in levels %}
                        <option value="{{ level }}">{{ level }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="filter_day" class="form-label">Jour</label>
                    <select class="form-select" id="filter_day" name="day">
                        <option value="">Tous les jours</option>
                        {% for day in days %}
                        <option value="{{ day }}">{{ day }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="filter_status" class="form-label">Statut</label>
                    <select class="form-select" id="filter_status" name="status">
                        <option value="">Tous les statuts</option>
                        <option value="active">Actif</option>
                        <option value="inactive">Inactif</option>
                    </select>
                </div>
                <div class="col-12">
                    <div class="d-flex justify-content-end gap-2">
                        <button type="reset" class="btn btn-outline-secondary">
                            <i class="fas fa-undo me-2"></i>Réinitialiser
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-filter me-2"></i>Filtrer
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Courses Grid -->
    <div class="row g-4">
        {% for course in courses %}
        <div class="col-md-6 col-lg-4">
            <div class="card course-card">
                <div class="card-header">
                    <div class="d-flex align-items-center">
                        <div class="icon-circle bg-primary bg-opacity-10 text-primary me-3">
                            <i class="fas fa-graduation-cap"></i>
                        </div>
                        <div>
                            <h5 class="card-title mb-0">{{ course.name }}</h5>
                            <p class="text-muted mb-0">{{ course.level }}</p>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <h6 class="text-uppercase text-muted mb-2">Professeur</h6>
                        <div class="d-flex align-items-center">
                            <div class="avatar-circle bg-primary bg-opacity-10 text-primary me-2">
                                <span>{{ course.teacher.name[0]|upper }}</span>
                            </div>
                            <span>{{ course.teacher.name }}</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <h6 class="text-uppercase text-muted mb-2">Emploi du temps</h6>
                        {% for schedule in course.schedules %}
                        <div class="schedule-item">
                            <i class="fas fa-calendar-day"></i>
                            <div>
                                <div class="fw-medium">{{ schedule.day }}</div>
                                <div class="text-muted">{{ schedule.start_time }} - {{ schedule.end_time }}</div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="mb-3">
                        <h6 class="text-uppercase text-muted mb-2">Statistiques</h6>
                        <div class="d-flex flex-wrap gap-2">
                            <span class="badge bg-light">
                                <i class="fas fa-users me-1"></i>{{ course.students|length }} étudiants
                            </span>
                            <span class="badge bg-light">
                                <i class="fas fa-clock me-1"></i>{{ course.duration }} minutes
                            </span>
                        </div>
                    </div>
                </div>
                <div class="card-footer">
                    <div class="d-flex justify-content-between align-items-center">
                        <button class="btn btn-sm btn-outline-primary" 
                                onclick="viewCourse({{ course.id }})"
                                data-bs-toggle="tooltip"
                                data-bs-placement="top"
                                title="Voir les détails">
                            <i class="fas fa-eye me-1"></i> Détails
                        </button>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-secondary" 
                                    onclick="editCourse({{ course.id }})"
                                    data-bs-toggle="tooltip"
                                    data-bs-placement="top"
                                    title="Modifier le cours">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" 
                                    onclick="deleteCourse({{ course.id }})"
                                    data-bs-toggle="tooltip"
                                    data-bs-placement="top"
                                    title="Supprimer le cours">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <div class="col-12">
            <div class="empty-state">
                <div class="icon-circle bg-primary bg-opacity-10 text-primary">
                    <i class="fas fa-graduation-cap"></i>
                </div>
                <h3>Aucun cours trouvé</h3>
                <p class="text-muted">Commencez par créer votre premier cours</p>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCourseModal">
                    <i class="fas fa-plus-circle me-2"></i> Créer un cours
                </button>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Add Course Modal -->
<div class="modal fade" id="addCourseModal" tabindex="-1" aria-labelledby="addCourseModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addCourseModalLabel">Nouveau Cours</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="addCourseForm" method="POST" action="{{ url_for('main.add_course') }}" data-ajax="true">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="course_name" class="form-label">Nom du cours</label>
                        <input type="text" class="form-control" id="course_name" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="course_level" class="form-label">Niveau</label>
                        <select class="form-select" id="course_level" name="level" required>
                            <option value="">Sélectionnez un niveau</option>
                            {% for level in levels %}
                            <option value="{{ level }}">{{ level }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="course_teacher" class="form-label">Professeur</label>
                        <select class="form-select" id="course_teacher" name="teacher_id" required>
                            <option value="">Sélectionnez un professeur</option>
                            {% for teacher in teachers %}
                            <option value="{{ teacher.id }}">{{ teacher.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="course_duration" class="form-label">Durée (minutes)</label>
                        <input type="number" class="form-control" id="course_duration" name="duration" required>
                    </div>
                    <div class="schedule-form">
                        <h6 class="mb-3">Emploi du temps</h6>
                        <div class="form-group">
                            <label for="schedule_day" class="form-label">Jour</label>
                            <select class="form-select" id="schedule_day" name="schedule_day" required>
                                {% for day in days %}
                                <option value="{{ day }}">{{ day }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="schedule_start_time" class="form-label">Heure de début</label>
                            <input type="time" class="form-control" id="schedule_start_time" name="schedule_start_time" required>
                        </div>
                        <div class="form-group">
                            <label for="schedule_end_time" class="form-label">Heure de fin</label>
                            <input type="time" class="form-control" id="schedule_end_time" name="schedule_end_time" required>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-plus-circle me-2"></i>Créer
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Course Modal -->
<div class="modal fade" id="editCourseModal" tabindex="-1" aria-labelledby="editCourseModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editCourseModalLabel">Modifier le Cours</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editCourseForm" method="POST" data-ajax="true">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="edit_course_name" class="form-label">Nom du cours</label>
                        <input type="text" class="form-control" id="edit_course_name" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_course_level" class="form-label">Niveau</label>
                        <select class="form-select" id="edit_course_level" name="level" required>
                            <option value="">Sélectionnez un niveau</option>
                            {% for level in levels %}
                            <option value="{{ level }}">{{ level }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="edit_course_teacher" class="form-label">Professeur</label>
                        <select class="form-select" id="edit_course_teacher" name="teacher_id" required>
                            <option value="">Sélectionnez un professeur</option>
                            {% for teacher in teachers %}
                            <option value="{{ teacher.id }}">{{ teacher.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="edit_course_duration" class="form-label">Durée (minutes)</label>
                        <input type="number" class="form-control" id="edit_course_duration" name="duration" required>
                    </div>
                    <div class="schedule-form">
                        <h6 class="mb-3">Emploi du temps</h6>
                        <div class="form-group">
                            <label for="edit_schedule_day" class="form-label">Jour</label>
                            <select class="form-select" id="edit_schedule_day" name="schedule_day" required>
                                {% for day in days %}
                                <option value="{{ day }}">{{ day }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="edit_schedule_start_time" class="form-label">Heure de début</label>
                            <input type="time" class="form-control" id="edit_schedule_start_time" name="schedule_start_time" required>
                        </div>
                        <div class="form-group">
                            <label for="edit_schedule_end_time" class="form-label">Heure de fin</label>
                            <input type="time" class="form-control" id="edit_schedule_end_time" name="schedule_end_time" required>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Enregistrer
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialisation des modales
    const addModal = new bootstrap.Modal(document.getElementById('addCourseModal'));
    const editModal = new bootstrap.Modal(document.getElementById('editCourseModal'));

    // Gestion des filtres
    const filterForm = document.getElementById('filterForm');
    filterForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(filterForm);
        const params = new URLSearchParams(formData);
        
        fetch(`/courses/filter?${params.toString()}`)
            .then(response => response.text())
            .then(html => {
                document.querySelector('.row.g-4').innerHTML = html;
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Une erreur est survenue lors du filtrage des cours.', 'danger');
            });
    });

    // Fonction pour voir les détails d'un cours
    window.viewCourse = function(courseId) {
        window.location.href = `/courses/${courseId}`;
    };

    // Fonction pour éditer un cours
    window.editCourse = function(courseId) {
        fetch(`/courses/${courseId}`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('edit_course_name').value = data.name;
                document.getElementById('edit_course_level').value = data.level;
                document.getElementById('edit_course_teacher').value = data.teacher_id;
                document.getElementById('edit_course_duration').value = data.duration;
                document.getElementById('edit_schedule_day').value = data.schedule.day;
                document.getElementById('edit_schedule_start_time').value = data.schedule.start_time;
                document.getElementById('edit_schedule_end_time').value = data.schedule.end_time;
                document.getElementById('editCourseForm').action = `/courses/${courseId}/edit`;
                editModal.show();
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Une erreur est survenue lors du chargement des données du cours.', 'danger');
            });
    };

    // Fonction pour supprimer un cours
    window.deleteCourse = function(courseId) {
        if (confirm('Êtes-vous sûr de vouloir supprimer ce cours ?')) {
            fetch(`/courses/${courseId}/delete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Cours supprimé avec succès !');
                    location.reload();
                } else {
                    showNotification('Erreur lors de la suppression du cours : ' + data.message, 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Une erreur est survenue lors de la suppression du cours.', 'danger');
            });
        }
    };
});
</script>
{% endblock %}
