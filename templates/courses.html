{% extends 'layout.html' %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">Course Management</h1>
    </div>
</div>

<!-- Add Course Button -->
<div class="row mb-4">
    <div class="col-12">
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCourseModal">
            <i class="fas fa-plus-circle me-2"></i>Add New Course
        </button>
    </div>
</div>

<!-- Course Tabs -->
<div class="card">
    <div class="card-header">
        <ul class="nav nav-tabs card-header-tabs" id="courseTabs" role="tablist">
            {% for day in days %}
            <li class="nav-item" role="presentation">
                <button class="nav-link {% if loop.first %}active{% endif %}" 
                        id="{{ day.lower() }}-tab" 
                        data-bs-toggle="tab" 
                        data-bs-target="#{{ day.lower() }}" 
                        type="button" 
                        role="tab" 
                        aria-controls="{{ day.lower() }}" 
                        aria-selected="{% if loop.first %}true{% else %}false{% endif %}">
                    {{ day }}
                </button>
            </li>
            {% endfor %}
        </ul>
    </div>
    <div class="card-body">
        <div class="tab-content" id="courseTabsContent">
            {% for day in days %}
            <div class="tab-pane fade {% if loop.first %}show active{% endif %}" 
                 id="{{ day.lower() }}" 
                 role="tabpanel" 
                 aria-labelledby="{{ day.lower() }}-tab">
                
                {% if courses_by_day[day] %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Course</th>
                                <th>Teacher</th>
                                <th>Telegram Group</th>
                                <th>Next Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for course in courses_by_day[day] %}
                            <tr>
                                <td>{{ course.start_time.strftime('%H:%M') }} - {{ course.end_time.strftime('%H:%M') }}</td>
                                <td>{{ course.course_name }}</td>
                                <td>{{ course.teacher_name }}</td>
                                <td>{{ course.telegram_group_id }}</td>
                                <td>
                                    {% if course.schedule_date %}
                                        {{ course.schedule_date.strftime('%d-%m-%Y') }}
                                    {% else %}
                                        <span class="badge bg-warning text-dark">Not scheduled</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-info edit-course-btn" 
                                            data-course-id="{{ course.id }}"
                                            data-course-name="{{ course.course_name }}"
                                            data-teacher-name="{{ course.teacher_name }}"
                                            data-day-of-week="{{ course.day_of_week }}"
                                            data-start-time="{{ course.start_time.strftime('%H:%M') }}"
                                            data-end-time="{{ course.end_time.strftime('%H:%M') }}"
                                            data-telegram-group-id="{{ course.telegram_group_id }}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger delete-course-btn" data-course-id="{{ course.id }}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info">No courses scheduled for {{ day }}.</div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Add Course Modal -->
<div class="modal fade" id="addCourseModal" tabindex="-1" aria-labelledby="addCourseModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addCourseModalLabel">Add New Course</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('add_course') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="course_name" class="form-label">Course Name</label>
                        <input type="text" class="form-control" id="course_name" name="course_name" required>
                    </div>
                    <div class="mb-3">
                        <label for="teacher_name" class="form-label">Teacher Name</label>
                        <input type="text" class="form-control" id="teacher_name" name="teacher_name" required>
                    </div>
                    <div class="mb-3">
                        <label for="day_of_week" class="form-label">Day of Week</label>
                        <select class="form-select" id="day_of_week" name="day_of_week" required>
                            <option value="0">Monday</option>
                            <option value="1">Tuesday</option>
                            <option value="2">Wednesday</option>
                            <option value="3">Thursday</option>
                            <option value="4">Friday</option>
                            <option value="5">Saturday</option>
                            <option value="6">Sunday</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="start_time" class="form-label">Start Time</label>
                        <input type="time" class="form-control" id="start_time" name="start_time" required>
                    </div>
                    <div class="mb-3">
                        <label for="end_time" class="form-label">End Time</label>
                        <input type="time" class="form-control" id="end_time" name="end_time" required>
                    </div>
                    <div class="mb-3">
                        <label for="telegram_group_id" class="form-label">Telegram Group ID</label>
                        <input type="text" class="form-control" id="telegram_group_id" name="telegram_group_id" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Course</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Course Modal -->
<div class="modal fade" id="editCourseModal" tabindex="-1" aria-labelledby="editCourseModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editCourseModalLabel">Edit Course</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editCourseForm" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="edit_course_name" class="form-label">Course Name</label>
                        <input type="text" class="form-control" id="edit_course_name" name="course_name" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_teacher_name" class="form-label">Teacher Name</label>
                        <input type="text" class="form-control" id="edit_teacher_name" name="teacher_name" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_day_of_week" class="form-label">Day of Week</label>
                        <select class="form-select" id="edit_day_of_week" name="day_of_week" required>
                            <option value="0">Monday</option>
                            <option value="1">Tuesday</option>
                            <option value="2">Wednesday</option>
                            <option value="3">Thursday</option>
                            <option value="4">Friday</option>
                            <option value="5">Saturday</option>
                            <option value="6">Sunday</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="edit_start_time" class="form-label">Start Time</label>
                        <input type="time" class="form-control" id="edit_start_time" name="start_time" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_end_time" class="form-label">End Time</label>
                        <input type="time" class="form-control" id="edit_end_time" name="end_time" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_telegram_group_id" class="form-label">Telegram Group ID</label>
                        <input type="text" class="form-control" id="edit_telegram_group_id" name="telegram_group_id" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Course Modal -->
<div class="modal fade" id="deleteCourseModal" tabindex="-1" aria-labelledby="deleteCourseModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteCourseModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this course? This action cannot be undone.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="deleteCourseForm" method="POST">
                    <button type="submit" class="btn btn-danger">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Handle Edit Course buttons
        document.querySelectorAll('.edit-course-btn').forEach(function(button) {
            button.addEventListener('click', function() {
                const courseId = this.getAttribute('data-course-id');
                const courseName = this.getAttribute('data-course-name');
                const teacherName = this.getAttribute('data-teacher-name');
                const dayOfWeek = this.getAttribute('data-day-of-week');
                const startTime = this.getAttribute('data-start-time');
                const endTime = this.getAttribute('data-end-time');
                const telegramGroupId = this.getAttribute('data-telegram-group-id');
                
                // Populate form
                document.getElementById('edit_course_name').value = courseName;
                document.getElementById('edit_teacher_name').value = teacherName;
                document.getElementById('edit_day_of_week').value = dayOfWeek;
                document.getElementById('edit_start_time').value = startTime;
                document.getElementById('edit_end_time').value = endTime;
                document.getElementById('edit_telegram_group_id').value = telegramGroupId;
                
                // Set form action
                document.getElementById('editCourseForm').action = `/courses/edit/${courseId}`;
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('editCourseModal'));
                modal.show();
            });
        });
        
        // Handle Delete Course buttons
        document.querySelectorAll('.delete-course-btn').forEach(function(button) {
            button.addEventListener('click', function() {
                const courseId = this.getAttribute('data-course-id');
                
                // Set form action
                document.getElementById('deleteCourseForm').action = `/courses/delete/${courseId}`;
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('deleteCourseModal'));
                modal.show();
            });
        });
    });
</script>
{% endblock %}
